<?php

namespace Tests\Feature;

use App\Models\Caja;
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class CajaOpenTest extends TestCase
{
    use RefreshDatabase;

    /**
     * Abrir caja para un usuario y verificar
     * que quede registrada con estado "Abierta".
     */
    public function test_admin_can_open_caja_and_persists_abierta_state(): void
    {
        // Usuario admin autenticado
        $admin = User::factory()->create([
            'role' => 'admin',
        ]);

        $this->actingAs($admin);

        // Abrir caja con un monto de apertura
        $response = $this->post(route('admin.cajas.store'), [
            'monto_apertura' => 100.00,
        ]);

        // Debe redirigir al índice de cajas del admin
        $response->assertRedirect(route('admin.cajas.index'));

        // Verificar que la caja quedó registrada en BD
        $this->assertDatabaseHas('caja', [
            'id_user' => $admin->id,
            'estado' => 'Abierta',
        ]);

        // Verificar que sólo haya una caja abierta para ese usuario
        $this->assertEquals(
            1,
            Caja::where('id_user', $admin->id)->where('estado', 'Abierta')->count()
        );
    }
}

